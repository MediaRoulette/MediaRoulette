name: Vault Integration Test

on:
  pull_request:
    paths:
      - 'src/main/java/me/hash/mediaroulette/utils/vault/**'
      - 'build.gradle.kts'
  workflow_dispatch:

jobs:
  test-vault-integration:
    runs-on: ubuntu-latest
    
    services:
      vault:
        image: vault:latest
        env:
          VAULT_DEV_ROOT_TOKEN_ID: testtoken
          VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
        ports:
          - 8200:8200
        options: >-
          --cap-add=IPC_LOCK
          --health-cmd="vault status"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Setup Vault AppRole and test data
      env:
        VAULT_ADDR: http://localhost:8200
        VAULT_TOKEN: testtoken
      run: |
        # Wait for Vault to be ready
        sleep 5
        
        # Enable AppRole auth method
        echo "Enabling AppRole auth method..."
        curl -s -X POST \
          -H "X-Vault-Token: testtoken" \
          -H "Content-Type: application/json" \
          -d '{"type":"approle"}' \
          http://localhost:8200/v1/sys/auth/approle
        
        # Create policy for mediaroulette
        echo "Creating mediaroulette policy..."
        curl -s -X PUT \
          -H "X-Vault-Token: testtoken" \
          -H "Content-Type: application/json" \
          -d '{"policy":"path \"secret/data/mediaroulette\" { capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\"] }"}' \
          http://localhost:8200/v1/sys/policies/acl/mediaroulette-policy
        
        # Create AppRole role
        echo "Creating AppRole role..."
        curl -s -X POST \
          -H "X-Vault-Token: testtoken" \
          -H "Content-Type: application/json" \
          -d '{"policies":["default","mediaroulette-policy"],"token_ttl":"1h","token_max_ttl":"4h"}' \
          http://localhost:8200/v1/auth/approle/role/mediaroulette
        
        # Get Role ID
        echo "Getting Role ID..."
        ROLE_ID=$(curl -s -H "X-Vault-Token: testtoken" \
          http://localhost:8200/v1/auth/approle/role/mediaroulette/role-id | jq -r '.data.role_id')
        echo "VAULT_ROLE_ID=$ROLE_ID" >> $GITHUB_ENV
        echo "Role ID: $ROLE_ID"
        
        # Generate Secret ID
        echo "Generating Secret ID..."
        SECRET_ID=$(curl -s -X POST -H "X-Vault-Token: testtoken" \
          http://localhost:8200/v1/auth/approle/role/mediaroulette/secret-id | jq -r '.data.secret_id')
        echo "VAULT_SECRET_ID=$SECRET_ID" >> $GITHUB_ENV
        echo "Secret ID generated successfully"
        
        # Write test secrets
        echo "Writing test secrets..."
        curl -s -X POST \
          -H "X-Vault-Token: testtoken" \
          -H "Content-Type: application/json" \
          -d '{"data":{"DISCORD_TOKEN":"test_token","MONGODB_CONNECTION":"mongodb://localhost:27017"}}' \
          http://localhost:8200/v1/secret/data/mediaroulette
        
        # Verify AppRole login works
        echo "Testing AppRole login..."
        LOGIN_RESULT=$(curl -s -X POST \
          -H "Content-Type: application/json" \
          -d "{\"role_id\":\"$ROLE_ID\",\"secret_id\":\"$SECRET_ID\"}" \
          http://localhost:8200/v1/auth/approle/login)
        echo "Login successful: $(echo $LOGIN_RESULT | jq -r '.auth.client_token != null')"

    - name: Build with Gradle
      run: ./gradlew build -x test

    - name: Run Vault integration tests
      env:
        VAULT_TEST_ENABLED: true
      run: |
        echo "Running Vault integration tests with AppRole..."
        echo "Role ID: ***"
        echo "Secret ID: ***"
        ./gradlew test --tests "me.hash.mediaroulette.utils.vault.*" --info

    - name: Test Vault configuration
      env:
        VAULT_ADDR: http://localhost:8200
        VAULT_TOKEN: testtoken
      run: |
        # Verify secrets are accessible via AppRole
        echo "Verifying AppRole authentication..."
        CLIENT_TOKEN=$(curl -s -X POST \
          -H "Content-Type: application/json" \
          -d "{\"role_id\":\"$VAULT_ROLE_ID\",\"secret_id\":\"$VAULT_SECRET_ID\"}" \
          http://localhost:8200/v1/auth/approle/login | jq -r '.auth.client_token')
        
        echo "Verifying secrets are accessible..."
        curl -s -H "X-Vault-Token: $CLIENT_TOKEN" \
          http://localhost:8200/v1/secret/data/mediaroulette | jq '.data.data'

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: vault-test-results
        path: build/test-results/test/*.xml

    - name: Summary
      run: |
        echo "✅ Vault integration build successful"
        echo "✅ AppRole authentication configured"
        echo "✅ Test secrets stored"
        echo "✅ Vault integration tests executed"
